# Using functions form other files to better organize code
from versionChecker import *
from fileReader import *
from pentest import *
from tkinter import *
from tkinter import ttk
import platform

# Initialize the GUI
current_os = platform.system()
root = Tk()
style = ttk.Style(root)
style.theme_use('alt')


def vulnerable_apps_window():
    apps = Toplevel(root)
    apps.title('Vulnerable Applications')
    apps.geometry('650x700')
    apps.resizable(False, False)
    appsLabel = Label(apps, text='Vulnerable Processes', font=('Helvetica', 12))
    appsLabel.place(x=250, y=10)

    if current_os == 'Windows':
        table = ttk.Treeview(apps, columns=('Name', 'Version', 'Vulnerability'), show='headings', height=25)
        table.column('# 1', anchor=CENTER, width=300)
        table.heading('# 1', text='Name')
        table.column('# 2', anchor=CENTER, width=200, stretch=NO)
        table.heading('# 2', text='Version')
        table.column('# 3', anchor=CENTER, width=100, stretch=NO)
        table.heading('# 3', text='Vulnerability')

        name, version = get_win()

        for i in range(len(name)):
            temp_name = name[i]
            temp_version = version[i]
            temp_vuln = db_search(temp_name)
            table.insert('', index=i, text='1', values=(temp_name, temp_version, temp_vuln))

    else:
        table = ttk.Treeview(apps, columns=('Name', 'Vulnerability'), show='headings', height=25)
        table.column('# 1', anchor=CENTER, width=320)
        table.heading('# 1', text='Name')
        table.column('# 2', anchor=CENTER, width=100, stretch=NO)
        table.heading('# 2', text='Vulnerability')

        name = get_linux()

        for i in range(len(name)):
            temp_name = name[i]
            temp_vuln = db_search(temp_name)
            table.insert('', index=i, text='1', values=(temp_name, temp_vuln))

    # get_apps and get_vulnerabilities buttons add unnecessary complexity to the program

    table.place(x=30, y=50)

    # Scrollbar
    table_scroll = ttk.Scrollbar(apps, orient=VERTICAL, command=table.yview)
    table_scroll.pack(side=RIGHT, fill='y')
    table.configure(yscrollcommand=table_scroll.set)

    info_label = Label(apps, text='More information on CVE IDs can be found at: https://cve.mitre.org/')
    info_label.place(x=50, y=650)


def database_testing_window():
    test = Toplevel(root)
    test.title('Database Testing')
    test.geometry('600x400')
    test.resizable(False, False)

    log_box = Label(test, text='Not Run Yet')

    warning_label = Label(test, text='Performing SQL Injection on Databases without prior consent from the owner of site is illegal.')
    url_label = Label(test, text='Enter URL:')
    url_entry = Entry(test, width=50)

    def run(): # runs when sql_button is clicked
        try:
            result = sql_injection(url_entry.get())
            result = list(dict.fromkeys(result)) # removes duplicates
        except:
            result = 'Check URL'
        log_box.config(text=result)

    inj_butt = Button(test, text='SQL Injection', width=12, command=run)

    url_label.place(x=50, y=50)
    url_entry.place(x=50, y=80)
    warning_label.place(x=50, y=110)
    inj_butt.place(x=50, y=150)
    log_box.place(x=50, y=200)


def quit_query():
    query = Toplevel(root)
    query.title('Quit')
    query.geometry('300x120')
    query.resizable(False, False)

    message_label = Label(query, text='Are you sure you want to quit?', font=('Helvetica', 12))
    message_label.place(x=40, y=10)

    message_label2 = Label(query, text='Quitting will close all open windows.', font=('Helvetica', 12))
    message_label2.place(x=20, y=40)

    quit_yes = Button(query, text='Yes', command=root.destroy, padx=18, pady=2)
    quit_yes.place(x=40, y=70)

    quit_no = Button(query, text='No', command=query.destroy, padx=18, pady=2)
    quit_no.place(x=150, y=70)


#Main Menu
root.title('Vulnerability Tool')
root.geometry('370x420')
root.resizable(False, False)

version_label = Label(root, text='Operating System detected: ' + current_os, font=('Helvetica', 12))
version_label.place(x=50, y=350)

menu_label = Label(root, text='Main Menu', font=('Helvetica', 16, 'bold'))
menu_label.place(x=50, y=20)

application_button = Button(root, text='Check for Vulnerable Applications', width=30, command=vulnerable_apps_window)
application_button.place(x=50, y=100)

database_button = Button(root, text='Database Penetration Testing', width=26, command=database_testing_window)
database_button.place(x=50, y=180)

quit_button = Button(root, text='Quit', width=10, command=quit_query)
quit_button.place(x=50, y=260)

root.protocol('WM_DELETE_WINDOW', quit_query)
root.mainloop()